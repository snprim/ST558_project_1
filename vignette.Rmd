---
title: "Vignette"
output: 
  github_document: 
    toc: true
---

```{r, echo = FALSE}
# rmarkdown::render("vignette.Rmd", output_format = "github_document", output_file = "README.md")
```
In this vignette, we want to show how to access APIs to retrieve data. We use two NHL repositories as examples: [NHL records](https://gitlab.com/dword4/nhlapi/-/tree/master) and [NHL stats](https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md).  

## Required Packages  

To be able to access data from APIs, you should install and load the `httr`, `jsonlite`, and `tidyverse` packages.  
    ```{r}
library(httr)
library(jsonlite)
library(tidyverse)
```

## Functions  

### NHL records API
```{r}
baseurl_records <- "https://records.nhl.com/site/api"
```
Here is a function to get basic information about all teams.  
/franchise (Returns id, ﬁrstSeasonId and lastSeasonId and name of every team in the history
of the NHL)  

```{r}
getFran <- function(){
  fullurl <- paste0(baseurl_records, "/", "franchise")
  fran <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(fran)
}
getFran() %>% head()
```
This is a function to retrieve stats about all teams.  
/franchise-team-totals (Returns Total stats for every franchise (ex roadTies, roadWins, etc))  
```{r}
getFranTeamTot <- function() {
  fullurl <- paste0(baseurl_records, "/", "franchise-team-totals")
  franTeamTot <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(franTeamTot)
}
getFranTeamTot() %>% head()
```
This function retrieves season records from one specific team, and therefore you need to provide the `franchiseId` as an argument. The ID can be found using `getFran` or `getFranTeamTot`.  
/site/api/franchise-season-records?cayenneExp=franchiseId=ID (Drill-down into season
records for a specific franchise)  
```{r}
getFranSeaRec <- function(franID) {
  fullurl <- paste0(baseurl_records, "/", "franchise-season-records?cayenneExp=franchiseId=", franID)
  franSeaRec <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(franSeaRec)
}
getFranSeaRec("20") %>% head()
```
This function retrieves goalie records, and again a `franchiseId` is required.  
/franchise-goalie-records?cayenneExp=franchiseId=ID (Goalie records for the specified
franchise)  
```{r}
getFranGoaRec <- function(franID) {
  fullurl <- paste0(baseurl_records, "/", "franchise-goalie-records?cayenneExp=franchiseId=", franID)
  franGoaRec <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(franGoaRec)
}
getFranGoaRec("20") %>% head()
```
This function retrieves information about skater records, and a `franchiseId` is required.  
/franchise-skater-records?cayenneExp=franchiseId=ID (Skater records, same interaction as
goalie endpoint)  
```{r}
getFranSkaRec <- function(franID) {
  fullurl <- paste0(baseurl_records, "/", "franchise-skater-records?cayenneExp=franchiseId=", franID)
  franSkaRec <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(franSkaRec)
}
getFranSkaRec("20") %>% head()
```

### NHL stats API  
  
For this function, eight modifiers can be chosen, and thus an argument (`expand`, `teamID`, or `stats`) has to be provided. Below are the eight modifiers:  

  * ?expand=team.roster Shows roster of active players for the specified team  
  * ?expand=person.names Same as above, but gives less info.  
  * ?expand=team.schedule.next Returns details of the upcoming game for a team  
  * ?expand=team.schedule.previous Same as above but for the last game played  
  * ?expand=team.stats Returns the teams stats for the season  
  * ?expand=team.roster&season=20142015 Adding the season identifier shows the roster for that season  
  * ?teamId=4,5,29 Can string team id together to get multiple teams  
  * ?stats=statsSingleSeasonPlayoffs Specify which stats to get. Not fully sure all of the values  

Examples of arguments:  

  * `expand = "person.names"`  
  * `teamId = "4, 5, 29"`  
  * `stats = "statsSingleSeasonPlayoffs"`  


```{r}
baseurl_stats <- "https://statsapi.web.nhl.com/api/v1/teams"
getStats <- function(expand = "", teamID = "", stats = ""){
  if (expand != ""){
    fullurl <- paste0(baseurl_stats, "?expand=", expand)
  } else if (teamID != ""){
    fullurl <- paste0(baseurl_stats, "?teamID=", teamID)
  } else if (stats != ""){
    fullurl <- paste0(baseurl_stats, "?stats=", stats)
  }
  stats <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(stats)
}
getStats(expand = "person.names") %>% head()
getStats(stats = "statsSingleSeasonPlayoffs") %>% head()
getStats(expand = "team.roster")

```
## A wrapper function for all the functions above  

Endpoints:  

  * franchise (getFran)  
  * team total (getFranTeamTot)  
  * season record (getFranSeaRec)  
  * goalie record (getFranGoaRec)  
  * skater record (getFranSkaRec)  
  * stats (getStats)  
    + expand = "team.roster"  
    + expand = "person.names"  
    + expand = "team.schedule.next"  
    + expand = "team.schedule.previous"  
    + expand = "team.stats"  
    + expand = "team.roster", season = "20142015"  
    + teamId = "4, 5, 29"  
    + stats = "statsSingleSeasonPlayoffs"  

```{r}
# add a 
nhlFun <- function(endpoints, ...){
  if (endpoints == "franchise") {
    getFran()
  } else if (endpoints == "team total") {
    getFranTeamTot()
  } else if (endpoints == "season record"){
    getFranSeaRec(...)
  } else if (endpoints == "goalie record"){
    getFranGoaRec(...)
  } else if (endpoints == "skater record"){
    getFranSkaRec(...)
  } else if (endpoints == "stats"){
    getStats(...)
  } else {
    stop("Please enter a valid endpoint")
  }
}
nhlFun(endpoints = "team total")
nhlFun(endpoints = "skater record", "20")
nhlFun(endpoints = "stats", expand = "person.team")
```

## Exploratory Data Analysis  

```{r}
# perhaps use the wrapper function here
franTot <- getFranTeamTot()
franTot <- franTot$data %>% select(-c("id", "activeFranchise", "firstSeasonId", "gameTypeId", "lastSeasonId"))
franStats <- getStats(expand = "person.names") 
franStats <- franStats$teams %>% select(c("locationName", "firstYearOfPlay", "franchiseId", "venue.city", "venue.timeZone.id", "venue.timeZone.tz", "division.name", "conference.name"))
combined <- full_join(franTot, franStats, by = "franchiseId") %>% mutate(winPercent = wins / gamesPlayed) %>% mutate(homeWinPercent = homeWins / wins)
head(combined)
ggplot(combined, aes(x = homeWins, y = homeLosses)) + geom_point(aes(color = division.name))
ggplot(combined, aes (x = winPercent)) + geom_histogram(aes(y = ..density..))
```


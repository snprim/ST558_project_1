---
title: "Vignette"
output: 
  github_document: 
    toc: true
---

```{r, echo = FALSE}
# rmarkdown::render("vignette.Rmd", output_format = "github_document", output_file = "README.md")
```
In this vignette, we want to show how to access APIs to retrieve data. We use two NHL repositories as examples: [NHL records](https://gitlab.com/dword4/nhlapi/-/tree/master) and [NHL stats](https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md).  

## Required Packages  

To be able to access data from APIs, you should install and load the `httr`, `jsonlite`, and `tidyverse` packages.  
    ```{r}
library(httr)
library(jsonlite)
library(tidyverse)
```

## Functions  

### NHL records API
```{r}
baseurl_records <- "https://records.nhl.com/site/api"
```
Here is a function to get basic information about all teams.  
/franchise (Returns id, ﬁrstSeasonId and lastSeasonId and name of every team in the history
of the NHL)  

```{r}
getFran <- function(){
  fullurl <- paste0(baseurl_records, "/", "franchise")
  fran <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(fran$data)
}
getFran() %>% head()

```
This is a function to retrieve stats about all teams.  
/franchise-team-totals (Returns Total stats for every franchise (ex roadTies, roadWins, etc))  
```{r}
getFranTeamTot <- function() {
  fullurl <- paste0(baseurl_records, "/", "franchise-team-totals")
  franTeamTot <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(franTeamTot$data)
}
getFranTeamTot() %>% head()
```
To allow for convenient access of team information in the following function, we first construct a subset of data, so users can use team names or franchise ID to look up information.  
```{r}
index <- getFranTeamTot() %>% select(c("franchiseId", "teamName")) %>% unique()
```

This function retrieves season records from one specific team, and therefore you need to provide the `franchiseId` or `teamName` as an argument. The ID can be found using `getFran` or `getFranTeamTot`.  
/site/api/franchise-season-records?cayenneExp=franchiseId=ID (Drill-down into season
records for a specific franchise)  
```{r}
getFranSeaRec <- function(team) {
  if (is.character(team)) {
    id <- index$franchiseId[index$teamName == team]
  } else if (is.numeric(team)){
    id <- team
  }
  fullurl <- paste0(baseurl_records, "/", "franchise-season-records?cayenneExp=franchiseId=", id)
  franSeaRec <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(franSeaRec$data)
}
getFranSeaRec(20) %>% head()
getFranSeaRec("Vancouver Canucks") %>% head()
```
This function retrieves goalie records, and again a `franchiseId` or `teamName` is required.  
/franchise-goalie-records?cayenneExp=franchiseId=ID (Goalie records for the specified
franchise)  
```{r}
getFranGoaRec <- function(team) {
  if (is.character(team)) {
    id <- index$franchiseId[index$teamName == team]
  } else if (is.numeric(team)){
    id <- team
  }
  fullurl <- paste0(baseurl_records, "/", "franchise-goalie-records?cayenneExp=franchiseId=", id)
  franGoaRec <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(franGoaRec$data)
}
getFranGoaRec(20) %>% head()
getFranGoaRec("Vancouver Canucks") %>% head()
```
This function retrieves information about skater records, and a `franchiseId` or `teamName` is required.  
/franchise-skater-records?cayenneExp=franchiseId=ID (Skater records, same interaction as
goalie endpoint)  
```{r}
getFranSkaRec <- function(team) {
  if (is.character(team)) {
    id <- index$franchiseId[index$teamName == team]
  } else if (is.numeric(team)){
    id <- team
  }
  fullurl <- paste0(baseurl_records, "/", "franchise-skater-records?cayenneExp=franchiseId=", id)
  franSkaRec <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  return(franSkaRec$data)
}
getFranSkaRec(20) %>% head()
getFranSkaRec("Vancouver Canucks") %>% head()
```

### NHL stats API  
  
For this function, eight modifiers can be chosen, and thus an argument (`expand`, `teamID`, or `stats`) has to be provided. Below are the eight modifiers:  

  * ?expand=team.roster Shows roster of active players for the specified team  
  * ?expand=person.names Same as above, but gives less info.  
  * ?expand=team.schedule.next Returns details of the upcoming game for a team  
  * ?expand=team.schedule.previous Same as above but for the last game played  
  * ?expand=team.stats Returns the teams stats for the season  
  * ?expand=team.roster&season=20142015 Adding the season identifier shows the roster for that season  
  * ?teamId=4,5,29 Can string team id together to get multiple teams  
  * ?stats=statsSingleSeasonPlayoffs Specify which stats to get. Not fully sure all of the values  

Examples of arguments:  

  * `expand = "person.names"`  
  * `teamId = "4, 5, 29"`  
  * `stats = "statsSingleSeasonPlayoffs"`  

For more information about these modifiers, see [the documentation](https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md).


```{r, echo = FALSE, eval = FALSE}
# figuring out NHL stats
# test2 <- GET("https://statsapi.web.nhl.com/api/v1/teams/54?expand=team.roster") %>% content("text") %>% fromJSON(flatten = TRUE)
# test2$teams$roster.roster
test3 <- GET("https://statsapi.web.nhl.com/api/v1/teams/54?expand=person.names") %>% content("text") %>% fromJSON(flatten = TRUE)
test3$teams
# test4 <- GET("https://statsapi.web.nhl.com/api/v1/teams/54?expand=team.schedule.next") %>% content("text") %>% fromJSON(flatten = TRUE)
# test4$teams$nextGameSchedule.dates
# test5 <- GET("https://statsapi.web.nhl.com/api/v1/teams/54?expand=team.stats") %>% content("text") %>% fromJSON(flatten = TRUE)
# test5$teams$teamStats
# test6 <- GET("https://statsapi.web.nhl.com/api/v1/teams/54?expand=team.schedule.previous") %>% content("text") %>% fromJSON(flatten = TRUE)
# test6$teams$previousGameSchedule.dates
test7 <- GET("https://statsapi.web.nhl.com/api/v1/teams?expand=team.roster&season=20142015") %>% content("text") %>% fromJSON(flatten = TRUE)
test7
test8 <- GET("https://statsapi.web.nhl.com/api/v1/teams?teamId=1,3,5") %>% content("text") %>% fromJSON(flatten = TRUE)
test8$teams
test9 <- GET("https://statsapi.web.nhl.com/api/v1/teams/54?stats=statsSingleSeasonPlayoffs") %>% content("text") %>% fromJSON(flatten = TRUE)
test9$teams
```


```{r}
baseurl_stats <- "https://statsapi.web.nhl.com/api/v1/teams"
getStats <- function(expand = "", teamID = "", stats = ""){
  if (teamID!=""){
    if (length(teamID)==1){
      baseurl_stats <- paste0("https://statsapi.web.nhl.com/api/v1/teams/", teamID)
    }
    else{
      fullurl <- paste0("https://statsapi.web.nhl.com/api/v1/teams?teamID=", teamID)
    }
  }
  if (expand != ""){
    fullurl <- paste0(baseurl_stats, "?expand=", expand)
  } else if (stats != ""){
    fullurl <- paste0(baseurl_stats, "?stats=", stats)
  }
  stats <- GET(fullurl) %>% content("text") %>% fromJSON(flatten = TRUE)
  if (expand == "team.roster"){
    stats <- stats$teams$roster.roster
  } else if (expand == "team.schedule.next"){
    stats <- stats$teams$nextGameSchedule.dates
  } else if (expand == "team.schedule.previous"){
    stats <- stats$teams$previousGameSchedule.dates
  } else if (expand == "team.stats"){
    stats <- stats$teams$teamStats
  }
  return(stats)
}
# it seems that we need to go into one more level to get person and roster info
getStats(teamID = 20, expand = "team.stats")
# getStats(expand = "team.roster&season=20142015") %>% head()
getStats(teamID = 53, expand = "team.roster")
# getStats(stats = "statsSingleSeasonPlayoffs") %>% head()

```
## A wrapper function for all the functions above  

Endpoints:  

  * franchise (getFran)  
  * team total (getFranTeamTot)  
  * season record (getFranSeaRec)  
  * goalie record (getFranGoaRec)  
  * skater record (getFranSkaRec)  
  * stats (getStats)  
    + expand = "team.roster"  
    + expand = "person.names"  
    + expand = "team.schedule.next"  
    + expand = "team.schedule.previous"  
    + expand = "team.stats"  
    + expand = "team.roster", season = "20142015"  
    + teamId = "4, 5, 29"  
    + stats = "statsSingleSeasonPlayoffs"  

See more details in the documentation of [NHL records](https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md) and [NHL stats](https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md).

```{r}
# add a 
nhlFun <- function(endpoints, ...){
  if (endpoints == "franchise") {
    getFran()
  } else if (endpoints == "team total") {
    getFranTeamTot()
  } else if (endpoints == "season record"){
    getFranSeaRec(...)
  } else if (endpoints == "goalie record"){
    getFranGoaRec(...)
  } else if (endpoints == "skater record"){
    getFranSkaRec(...)
  } else if (endpoints == "stats"){
    getStats(...)
  } else {
    stop("Please enter a valid endpoint")
  }
}
nhlFun(endpoints = "skater record", "20")
nhlFun(endpoints = "stats", expand = "person.team")
# nhlFun(endpoints = "team total")
```

## Exploratory Data Analysis  

```{r}
# perhaps use the wrapper function here
franTot <- getFranTeamTot()
str(franTot)
franTot <- franTot %>% select(-c("id", "activeFranchise", "firstSeasonId", "gameTypeId", "lastSeasonId"))
franStats <- getStats(expand = "person.names") 
franStats <- franStats$teams %>% select(c("locationName", "firstYearOfPlay", "franchiseId", "venue.city", "venue.timeZone.id", "venue.timeZone.tz", "division.name", "conference.name"))
combined <- full_join(franTot, franStats, by = "franchiseId") %>% mutate(winPercent = wins / gamesPlayed, homeWinPercent = homeWins / wins)
head(combined)
ggplot(combined, aes(x = homeWins, y = homeLosses)) + geom_point(aes(color = division.name))
ggplot(combined, aes (x = winPercent)) + geom_histogram(aes(y = ..density..))
```

